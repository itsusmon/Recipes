#!/bin/bash

# Pre-commit hook to run spotlessApply on changed Kotlin files

# Get the list of staged Kotlin files
STAGED_KOTLIN_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(kt|kts) | tr '
' ',' | sed 's/,$//')

# If there are no Kotlin files, exit early
if [ -z "$STAGED_KOTLIN_FILES" ]; then
    echo "No Kotlin files to format."
    exit 0
fi

echo "Running spotlessApply on changed Kotlin files..."
echo "Files: $STAGED_KOTLIN_FILES"

# Run spotlessApply on the changed files
./gradlew spotlessApply -PspotlessFiles="$STAGED_KOTLIN_FILES"

# Check if spotlessApply made changes
if [ $? -eq 0 ]; then
    echo "Spotless formatting completed."
    # Add the formatted files back to staging
    IFS=',' read -ra FILES <<< "$STAGED_KOTLIN_FILES"
    for file in "${FILES[@]}"; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done
    echo "Formatted files have been added to staging."
fi